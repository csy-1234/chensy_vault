---
date: "20250819"
docx:
  - sql语句.docx
  - mysql数据备份.docx
---
sql语句.docx
mysql备份与恢复.docx
# sql语句
## 笔记

==sql语句分类==

==安装数据库==

==库操作==

==表操作==

==数据类型==

==单表查询+查询语法==

==navicate客户端工具==
# mysql数据备份
## 笔记
==mysql完全备份与恢复==

==数据库备份类型==

>物理备份、逻辑备份
>完全备份、增量备份、差异备份
>
>Differential Backup都**基于同一个全量备份点**
>incremental backup 记录**上次备份之后的变化**

==常见备份方法==

>mysqldump完全备份
binlog增量备份
第三方工具备份xtrabackup

==数据库及数据准备==

==使用mysqldump全量备份==

==恢复全量数据==

>source
>mysql

==mysql备份策略==

>定期
>完全+增量
>定期备份实验

==mysql增量备份与恢复==

>mysqlbinlog

==mysqlq企业备份案例==

>全量备份+增量备份
>全量恢复+增量恢复（基于时间点、位置）

## 实验
目的：备份mysql（包管理器安装）
机器：一台vm
软件：mysql8.0.42
效果：
	全量备份+删+恢复
	增量备份+删+恢复
	全量+增量备份+删+与恢复
```
\#数据准备 
show databases;
create database abc;
use abc;
create table t2(
    id int not null unique auto_increment,
    name varchar(20) not null,
    sex enum('male','female') not null default 'male',
    age int(3) unsigned not null default 28,
    hire_date date not null,
    post varchar(50),
    post_comment varchar(100),
    salary double(15,2),
    office int,
    depart_id int
) ENGINE = InnoDB DEFAULT CHARSET = utf8;

insert into t2(name,sex,age,hire_date,post,salary,office,depart_id) values
('貂蝉','male',18,'20170301','宇宙驻地球办事处外交大使',7300.33,401,1),
('蔡文姬','male',78,'20150302','teacher',1000000.31,401,1),
('安其拉','male',81,'20130305','teacher',8300,401,1),
('孙悟空','male',73,'20140701','teacher',3500,401,1),
('后羿','male',48,'20101111','teacher',10000,401,1),
('鸭鸭','female',28,'20170127','sale',4000.33,402,2),
('程咬钢','male',28,'20160311','operation',10000.13,403,3),
('程咬金','male',18,'19970312','operation',20000,403,3);
select * from t2;
```

![[938226798ccae0b91ba20c09349b049.jpg]]

![[097988cab578eadcb3cfc487ee3dd2a.jpg]]

## 补充

 ==对比全量与增量的记录的是什么内容？记录内容的粒度大小？==
 
全量备份 (Full Backup)
- 记录内容：
    - 是某一时刻数据库的 快照 (snapshot)，包括 表结构 + 表数据

- 恢复时能得到：
	- 完整的快照。
- 最小恢复单位：**库 / 表**（因为快照是结构 + 数据，可以按表恢复）。


 增量备份 (Incremental Backup)
- 记录内容：
    - 数据库自上一次备份以来的 变更操作，通常来自日志（如 binlog、WAL 日志、AOF 等）。
    最小恢复单位：写操作 (精确到语句/事务)
总结：
- 全量备份 = 快照，不是日志
- 增量备份 = 写操作日志
- 恢复粒度：全量按表，增量按操作

==企业备份策略是什么样的？==
「全量 + 增量」配合
- 全量快照：提供一个「基准点」——某个时间点数据库的完整状态。
- 增量日志：记录自这个时间点之后的所有变化。

假设你的备份策略是：

- 周日做一次全量快照
    
- 周一到周六做增量备份
    

那么：

- 如果数据库在周四宕机 → 恢复步骤是：
    
    1. 先恢复**周日的全量快照**（得到周日的状态）。
        
    2. 然后依次应用周一、周二、周三、周四的增量日志。
        
    3. 得到宕机前最新的数据状态。

**常见策略**：定期全量（比如每周），配合频繁增量（比如每天/每小时）。

==自动化备份？==

|步骤|工具/方法|自动化方式|输出|
|---|---|---|---|
|全量备份|mysqldump / XtraBackup|cron / Jenkins 自动触发|`/backup/full_YYYY-MM-DD.sql` 或目录|
|增量备份|mysqlbinlog / XtraBackup 增量|实时采集 binlog / cron 定时采集|`/backup/incr_YYYY-MM-DD_xxx.binlog`|
|元数据维护|JSON / YAML / txt 文件|自动写入|标记增量起点：binlog 文件名 + position|
|上传存储|rsync / OSS CLI / S3 CLI|自动上传|冷存储可回溯备份|
|高可用|MySQL 主从复制 / 多副本集群|实时同步|可读从库，主库故障切换|
- 企业备份不是手动命令，而是通过 **定时任务 + 自动化脚本 + 实时采集框架** 完成
    
- **冷备份**：全量 + 实时增量 → 可回溯
    
- **热备份**：主从复制 / 多副本 → 高可用
    
- **元数据**：保证增量恢复连续
    
- **第三方工具**（Percona XtraBackup、Canal、Debezium）是企业常用方案

|组成部分|作用|典型工具/实现|
|---|---|---|
|定时任务|定期触发全量备份|cron / Jenkins|
|自动化脚本|自动化执行全量+增量备份、上传、清理等|Shell / Python / Ansible|
|实时采集框架|捕获实时增量数据，保证无缝衔接|Canal / Maxwell / Debezium|

==为什么是混合模式而不是单独的增量模式？==

 单独增量备份的缺点

1. **恢复速度慢**
    
    - 增量备份只记录数据库的操作日志（写操作、DDL 等），没有直接保存数据库的最终状态。
        
    - 恢复时必须 **从数据库空状态开始**，顺序回放所有增量操作才能得到目标状态。
        
    - 相比全量快照（直接保存最终状态的 SQL 文件或物理数据文件），恢复速度慢，耗时长。
        
2. **连续性要求高、风险大**
    
    - 增量备份必须保持完整的连续日志链。
        
    - **任意一个增量文件丢失**，后续的回放就会失败，导致无法恢复到最新状态。
        
    - 无法随意中断或跳过缺失部分，依赖严格的连续性。
        
3. **管理复杂、容易出错**
    
    - 随着时间推移，增量文件数量增加，必须精确管理文件顺序和完整性。
        
    - 对应恢复点的定位（时间或位置）必须非常精准，否则可能回放错序或漏掉操作。
        

- **全量快照 + 增量备份（混合式）** 的优势在于：
    
    1. **全量快照提供可中断的基准点** → 即使近期增量丢失，也能恢复到全量备份时间点，减少数据损失。
        
    2. **增量回放量减少** → 恢复更快、更安全。
        
- 所以增量备份的 **连续性要求** 和全量快照的 **可中断性** 是决定安全性和恢复可靠性的关键因素。

==增量备份有两种方式备份方式？==
- **恢复数据** → **流式回放 binlog**（直接管道给 `mysql`）
    
- **查看 / 编辑 / 归档** → **先导出为 SQL 文件**（用 `mysqlbinlog > file.sql`）

==实际配置建议==？

---

 ✅ 一、最简配置（能跑）

主库（Master）

```ini
[mysqld]
server-id=1
log-bin=mysql-bin
```

 从库（Slave）

```ini
[mysqld]
server-id=2
relay-log=relay-bin
```

> 这就是最小可运行配置。能实现主从复制，但不推荐用于生产。

---

🧩 二、推荐的完整配置（生产建议）

🔹 主库（Master）

```ini
[mysqld]
server-id=1
log-bin=mysql-bin              # 启用二进制日志（主从同步的基础）
binlog_format=ROW              # 行格式，推荐（相比STATEMENT更安全）
sync_binlog=1                  # 每次事务提交时同步binlog到磁盘，防止丢失
expire_logs_days=7             # 自动清理过期的binlog文件
binlog_cache_size=1M           # binlog缓存区大小
max_binlog_size=500M           # 每个binlog文件最大大小
binlog_do_db=mydb              # （可选）指定需要同步的数据库
# binlog_ignore_db=test        # （可选）忽略同步的数据库
innodb_flush_log_at_trx_commit=1  # 保证事务持久性
```

 🔹 从库（Slave）

```ini
[mysqld]
server-id=2
relay-log=relay-bin
relay-log-index=relay-bin.index
read_only=1                     # 防止误写（除复制线程外不能写）
log_slave_updates=1             # 从库也记录 binlog（用于级联复制或故障转移）
skip_slave_start=1              # 启动时不自动开始复制（手动控制更安全）
relay_log_recovery=1            # 异常中断后自动恢复relay log一致性
sync_relay_log=1
sync_relay_log_info=1
sync_master_info=1
```

---

🔐 三、复制账号配置

主从之间要有独立复制账号，建议：

```sql
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
```

---

⚙️ 四、从库执行主从连接命令

```sql
CHANGE MASTER TO
  MASTER_HOST='主库IP',
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=120;
START SLAVE;
```

---

🧠 总结（按重要性排序）

|级别|配置项|说明|
|---|---|---|
|必需|`server-id`|主从唯一标识|
|必需|`log-bin`（主）/ `relay-log`（从）|启用日志机制|
|强烈推荐|`binlog_format=ROW`|避免主从不一致|
|强烈推荐|`sync_binlog=1`、`innodb_flush_log_at_trx_commit=1`|数据安全|
|推荐|`read_only=1`、`log_slave_updates=1`|防误写、支持级联|
|推荐|`relay_log_recovery=1`|自动修复复制一致性|
|可选|`expire_logs_days`、`max_binlog_size`|控制日志大小与清理策略|

---

是否希望我帮你写一个**完整的主从配置模板文件（主库+从库）**，带中文注释？那样可以直接放进 `/etc/my.cnf` 实测使用。